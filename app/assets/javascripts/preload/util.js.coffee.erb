<% environment.context_class.instance_eval { include Rails.application.routes.url_helpers } %>

window.subscribeTo = []
window.unsubscribeFrom = []

window.isMobile = () ->
  navigator.userAgent.match(/Mobile|webOS/) != null
  
window.showLoginDialog = (confirmEmailAddress) ->
  if confirmEmailAddress != null
    $("#sign_in_flash").html("check email-account "+confirmEmailAddress+" first for confirmation-mail")
  $("#sign_in_modal").dialog('open')

sendAuthFormOn13 = (event) ->
  if (event.which == 13 || event.keyCode == 13)
    submit = $('#auth_signin_email').val() != '' && $('#auth_signin_password').val() != ''
    if submit
      $(event.target).closest('form').submit()

$(document).on 'keyup', '#auth_signin_email', (event) ->
    sendAuthFormOn13 event

$(document).on 'keyup', '#auth_signin_password', (event) ->
    sendAuthFormOn13 event

$(document).on 'keyup', '.edit_detail', (event) ->
  if (event.which == 13 || event.keyCode == 13)
    event.preventDefault()
    $(this).closest('form').submit()

window.cacheStats = () ->
  tilesSize = Comm.StorageController.instance().getByteSize('tiles')
  numTiles = Comm.StorageController.instance().getNumElements('tiles')
  showCacheStats(numTiles, tilesSize)

window.showCacheStats = (numTiles, tilesSize) ->
  fileSysLink = ''
  color = (if isMobile() then 'black' else 'white')
  if Comm.StorageController.isFileBased()
    fileSysLink = ' / <span style="color:'+color+';">[<a href="filesystem:http://'+document.location.host+'/persistent/" style="color:'+color+';">show</a>]</span>'
  $('#cache_stats').html('<span><span style="color:'+color+';">cache-size: '+Math.round(tilesSize / 1024)+' kB / #'+numTiles+' tiles</span>'+fileSysLink+'</span>')

jQuery ->
#  $.ajaxSetup({
#    headers: {
#      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
#    }
#  })

  $.fn.selectRange = (start, end) ->
    if !end
      end = start
    this.each () ->
      if this.setSelectionRange
        this.focus()
        this.setSelectionRange(start, end)
      else if this.createTextRange
        range = this.createTextRange()
        range.collapse(true)
        range.moveEnd('character', end)
        range.moveStart('character', start)
        range.select()
