<% environment.context_class.instance_eval { include Rails.application.routes.url_helpers } %>

window.isMobile = () ->
  navigator.userAgent.match(/Mobile|webOS/) != null
  
window.showLoginDialog = (confirmEmailAddress) ->
  if confirmEmailAddress != null
    $("#sign_in_flash").html("check email-account "+confirmEmailAddress+" first for confirmation-mail")
  $("#sign_in_modal").dialog('open')

sendAuthFormOn13 = (event) ->
  if (event.which == 13 || event.keyCode == 13)
    submit = $('#auth_signin_email').val() != '' && $('#auth_signin_password').val() != ''
    if submit
      $(event.target).closest('form').submit()
      if isMobile()
        $('#sign_in_cancel').click()
      else
        signInDialog.dialog("close")

$(document).on 'keyup', '#auth_signin_email', (event) ->
    sendAuthFormOn13 event

$(document).on 'keyup', '#auth_signin_password', (event) ->
    sendAuthFormOn13 event

$(document).on 'keyup', '.edit_detail', (event) ->
  if (event.which == 13 || event.keyCode == 13)
    event.preventDefault()
    $(this).closest('form').submit()

window.padTextHtml = (text, minLength) ->
  count = 0
  while text.length < minLength
    count += 1
    text += if count%5==0 then ' ' else '.'
  text.replace(/([ .]+)$/, ' <span style="color:white;">$1</span>')

window.cacheStats = () ->
  tilesSize = Comm.StorageController.instance().getByteSize('tiles')
  numTiles = Comm.StorageController.instance().getNumElements('tiles')
  showCacheStats(numTiles, tilesSize)

window.showCacheStats = (numTiles, tilesSize) ->
  fileSysLink = ''
  color = (if isMobile() then 'black' else 'white')
  if Comm.StorageController.isFileBased()
    if window.isMobile()
      fileSysLink = ' / <span style="color:'+color+';">[<a href="javascript:showCacheFileView();" style="color:'+color+';">show</a>]</span>'
    else
      fileSysLink = ' / <span style="color:'+color+';">[<a href="filesystem:http://'+document.location.host+'/persistent/" style="color:'+color+';">show</a>]</span>'
  $('#cache_stats').html('<span><span style="color:'+color+';">cache-size: '+Math.round(tilesSize / 1024)+' kB / #'+numTiles+' tiles</span>'+fileSysLink+'</span>')

window.showCacheFileView = () ->
  $('#cache_view').css('display', 'block')
  $('#cache_view').attr('src', 'filesystem:http://'+document.location.host+'/persistent/')


window.searchBounds = (lat, lng, radiusMeters) ->
  if radiusMeters <= 0
    return null

  conv_factor = (2.0 * Math.PI)/360.0;
  latRad = lat * conv_factor;

  m1 = 111132.92
  m2 = -559.82
  m3 = 1.175
  m4 = -0.0023
  p1 = 111412.84
  p2 = -93.5
  p3 = 0.118
  latlen = m1 + (m2 * Math.cos(2 * latRad)) + (m3 * Math.cos(4 * latRad)) + (m4 * Math.cos(6 * latRad))
  longlen = (p1 * Math.cos(latRad)) + (p2 * Math.cos(3 * latRad)) + (p3 * Math.cos(5 * latRad))
  meterLat = 1.0 / latlen
  meterLng = 1.0 / longlen

  diameterLat = meterLat * radiusMeters
  diameterLng = meterLng * radiusMeters
  inner_square_half_side_length_lat = Math.round(Math.sqrt((2*diameterLat)**2) / 2*10000000)/10000000
  inner_square_half_side_length_lng = Math.round(Math.sqrt((2*diameterLng)**2) / 2*10000000)/10000000
  
  searchBounds = {lng_east: lng-inner_square_half_side_length_lng,\
                  lng_west: lng+inner_square_half_side_length_lng,\
                  lat_south: lat-inner_square_half_side_length_lat,\
                  lat_north: lat+inner_square_half_side_length_lat}


jQuery ->
#  $.ajaxSetup({
#    headers: {
#      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
#    }
#  })

  $.fn.selectRange = (start, end) ->
    if !end
      end = start
    this.each () ->
      if this.setSelectionRange
        this.focus()
        this.setSelectionRange(start, end)
      else if this.createTextRange
        range = this.createTextRange()
        range.collapse(true)
        range.moveEnd('character', end)
        range.moveStart('character', start)
        range.select()
