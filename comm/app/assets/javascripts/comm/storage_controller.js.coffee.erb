class window.Comm.StorageController

  @_SINGLETON = new StorageController(null)

  constructor: (TODO_storeKey) ->
    unless Modernizr.localstorage
      alert('This Browser Doesn\'t Support Local Storage.')
    @_jsonObjects = {}
  
  # reserved listKeys:
  # push: creates/uses an array for entries stored with storeKey
  # if an array is defined for a storeKey then there can't be any other objects defined aside (@see this.pop())
  addToList: (storeKey, listKey, data) ->
    stored = localStorage.getItem(storeKey)
    if stored == null
      listEntries = {}
      if listKey == 'push'
        listEntries[listKey] = [data]
      else
        @_jsonObjects[storeKey] = listEntries
        listEntries[listKey] = data
      localStorage.setItem(storeKey, JSON.stringify(listEntries));
    else
      if stored.trim().match(/^\{/) == null
        alert('expected Object/List - change of EntryType not implemented')
      else
        storedJSON = @_jsonObjects[storeKey]
        unless storedJSON?
          storedJSON = eval("(" + stored + ")")
          @_jsonObjects[storeKey] = storedJSON
        if listKey == 'push'
         #storedJSON[listKey].push(data) # LIFO with push
          storedJSON[listKey].splice(0, 0, data) # FIFO with push
        else
          storedJSON[listKey] = data
        localStorage.setItem(storeKey, JSON.stringify(storedJSON));

  get: (storeKey, listKey) ->
    # FIXME @_jsonObjects is an internal cache-object and should not be exposed to concurrent access
    #       readonly but 'live' copy -> wrapper object! with methods getItem() for [] and real object 
    @_jsonObjects[storeKey] || eval("(" + localStorage.getItem(storeKey) + ")")

  getNumElements: (storeKey, listKey = null) ->
    # TODO listKey != null, id might not be available
    if @_jsonObjects[storeKey]?
      Object.keys(@_jsonObjects[storeKey]).length
    else
      stored = localStorage.getItem(storeKey)
      if stored != null then (stored.match(/("id":)/g)||[]).length else 0
    #stored = localStorage.getItem(storeKey)
    #(if stored != null then Math.round(localStorage[storeKey].length/1024) else 0)+' kB'

  getByteSize: (storeKey, listKey = null) ->
    # TODO listKey != null
    stored = localStorage.getItem(storeKey)
    if stored != null then stored.length else 0

  delete: (storeKey, listKey = null) ->
    # TODO listKey != null
    localStorage.removeItem('tiles')
    if @_jsonObjects[storeKey]?
      @_jsonObjects[storeKey] = null

  # expects an array stored with 'push' as listKey in storeKey-entry
  # TODO cache list-object as well like @_jsonObjects
  pop: (storeKey) ->
    stored = localStorage.getItem(storeKey)
    unless stored == null
      storedJSON = eval("(" + stored + ")")
      listEntries = storedJSON['push']
      if listEntries?
        listEntry = listEntries.pop()
        if listEntries.length >= 1
          localStorage.setItem(storeKey, JSON.stringify(listEntries));
        else
          localStorage.removeItem(storeKey)
        listEntry
    else
      null

  @instance: () ->
    @_SINGLETON

#
# provides readonly-'live'-access to storage-entry
#
class Comm.StorageEntryWrapper
  
  constructor: (jsonObject) ->
    @_jsonObject = jsonObject

  getItem: (key) ->
    @_jsonObject[key]